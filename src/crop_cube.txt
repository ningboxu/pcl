#include <pcl/io/pcd_io.h>
#include <pcl/point_types.h>
#include <pcl/filters/crop_box.h>
#include <pcl/common/transforms.h>
#include <pcl/visualization/pcl_visualizer.h>
#include <Eigen/Dense>
#include <cstdlib>
#include <ctime>

// 生成模拟点云数据
void generatePointCloud(pcl::PointCloud<pcl::PointXYZ>::Ptr cloud,
                        int num_points)
{
    cloud->width  = num_points;
    cloud->height = 1;
    cloud->points.resize(num_points);

    // 随机生成点云
    for (int i = 0; i < num_points; ++i)
    {
        cloud->points[i].x = rand() % 10;
        cloud->points[i].y = rand() % 10;
        cloud->points[i].z = rand() % 10;
    }
}

// 裁剪点云数据
void cropPointCloud(const pcl::PointCloud<pcl::PointXYZ>::Ptr& cloud,
                    pcl::PointCloud<pcl::PointXYZ>::Ptr& cloud_clipped,
                    const Eigen::Vector3f& cube_center, float cube_length,
                    const Eigen::Matrix3f& rotation_matrix)
{
    pcl::CropBox<pcl::PointXYZ> crop_filter;
    Eigen::Vector4f min_point(-cube_length / 2, -cube_length / 2,
                              -cube_length / 2, 1.0);
    Eigen::Vector4f max_point(cube_length / 2, cube_length / 2, cube_length / 2,
                              1.0);

    crop_filter.setMin(min_point);
    crop_filter.setMax(max_point);
    crop_filter.setRotation(rotation_matrix);
    crop_filter.setTranslation(cube_center);

    crop_filter.setInputCloud(cloud);
    crop_filter.filter(*cloud_clipped);
}

// 可视化点云数据
void visualizePointCloud(
    const pcl::PointCloud<pcl::PointXYZ>::Ptr& cloud,
    const pcl::PointCloud<pcl::PointXYZ>::Ptr& cloud_clipped)
{
    pcl::visualization::PCLVisualizer viewer("Point Cloud Viewer");

    // 添加原始点云
    viewer.addPointCloud<pcl::PointXYZ>(cloud, "original cloud");
    viewer.setPointCloudRenderingProperties(
        pcl::visualization::PCL_VISUALIZER_COLOR, 0.0, 1.0, 0.0,
        "original cloud");

    // 添加裁剪后的点云
    viewer.addPointCloud<pcl::PointXYZ>(cloud_clipped, "clipped cloud");
    viewer.setPointCloudRenderingProperties(
        pcl::visualization::PCL_VISUALIZER_COLOR, 1.0, 0.0, 0.0,
        "clipped cloud");

    // 添加坐标系
    viewer.addCoordinateSystem(1.0);

    // 设置视角
    viewer.setCameraPosition(0, 0, -15, 0, -1, 0);

    // 主循环
    while (!viewer.wasStopped())
    {
        viewer.spinOnce(100);
    }
}

int main(int argc, char** argv)
{
    srand(time(0));  // 初始化随机数种子

    // 1. 生成模拟点云数据
    pcl::PointCloud<pcl::PointXYZ>::Ptr cloud(
        new pcl::PointCloud<pcl::PointXYZ>);
    generatePointCloud(cloud, 1000);  // 生成 1000 个点

    // 2. 定义裁剪区域的参数
    Eigen::Vector3f cube_center(5.0, 5.0, 5.0);  // 立方体中心
    float cube_length = 4.0;                     // 立方体的边长
    Eigen::Matrix3f rotation_matrix;

    // 立方体的旋转矩阵，假设绕Z轴旋转45度
    float angle = M_PI / 4.0;  // 旋转 45 度
    rotation_matrix << cos(angle), -sin(angle), 0, sin(angle), cos(angle), 0, 0,
        0, 1;

    // 3. 裁剪点云
    pcl::PointCloud<pcl::PointXYZ>::Ptr cloud_clipped(
        new pcl::PointCloud<pcl::PointXYZ>);
    cropPointCloud(cloud, cloud_clipped, cube_center, cube_length,
                   rotation_matrix);

    // 4. 可视化原始点云和裁剪后的点云
    visualizePointCloud(cloud, cloud_clipped);

    return 0;
}
